---
title: "The impact of vaccines, case of Measles in USA"
date: "2019-10-07T13:39:46+02:00"
author: "Datapleth.io"
tags: ["api", "map"]
categories: ["geography"]
banner: "blog/img/example_satellite_mapbox_0.png"
output: html_document
---

<img src="https://miro.medium.com/max/1248/1*-Rb6MUZMO8fYnhOTpEUrKA.png">

Figure 3: DeBold & Freedmanâ€™s (2015) graph of the impact of vaccination on measles. The visual message requires few words. Source: http://graphics.wsj.com/infectious-diseases-and-vaccines/


http://graphics.wsj.com/infectious-diseases-and-vaccines/

demo of [tycho](https://www.tycho.pitt.edu/dataset/api/) satellite API. 

https://medium.com/@michael.friendly/visual-thinking-graphic-discoveries-128468677592

## Preparation

We will need first several geographical and graphical libraries of R

```{r loadlibs, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra) # for table rendering
library(glue)
library(curl)
library(slippymath)
library(purrr)
library(png)
library(dplyr)
library(ggplot2)
library(data.table)
```


```{r myparameters, message=FALSE, warning=FALSE}
api_key_tycho <- Sys.getenv("API_TYCHO")

```

Let's download the data from Tycho project API. This dataset has to be agredated
as condition data are provided on a weekly basis.

```{r getData, message=FALSE, warning=FALSE}
# a function to download data from Tycho Website
getTychoCondition <- function(
    condition = "Measles"
    , country_iso = "US"
    , offset = 0
    , limit = 20000
    , api_key_tycho = NULL
){
    url <- glue::glue("https://www.tycho.pitt.edu/api/query?apikey={api_key_tycho}&ConditionName={condition}&CountryISO={country_iso}&limit={limit}&offset={offset}")
    data <- data.table::fread(url)
    return(data)
}
## Loop & Merge
mydata <- lapply(
    (0:21)*20000L
    , getTychoCondition
    , condition = "Measles", country_iso = "US"
    , limit = 20000, api_key_tycho = api_key_tycho)
measles <- data.table::rbindlist(mydata)
```

```{r agregateData}
# add year
measles[ , year := lubridate::year(anytime::anydate(PeriodStartDate))]

measles_ag <- measles %>% group_by(Admin1Name,year) %>% summarise_at(c("Fatalities","CountValue"), sum) %>% data.table::as.data.table()
data.table::setnames(measles_ag, c("state", "year", "fatalities", "cases"))
head(measles_ag)
measles_ag[ , state := as.factor(state) ]
```



```{r heatmap}
dt <- measles_ag[ year > 1929 &
                      ! (state %in% c("AMERICAN SAMOA","GUAM", "NORTHERN MARIANA ISLANDS", "PUERTO RICO"))]

g <- ggplot(data = dt, aes(x = year, y = state, fill = cases)) +
    geom_tile(colour="white", linejoin = 2, 
              width=.9, height=.9) + theme_minimal()  +
    scale_fill_viridis_c(
        na.value=rgb(246, 246, 246, max=255)
        #, limits=c(0, 4000)
        , direction = -1, option = "A"
        ) +
    scale_y_discrete(limits = rev(levels(droplevels(dt$state)))) +
    scale_x_continuous(expand=c(0,0), 
                       breaks=seq(1930, 2010, by=10)) +
    geom_segment(x=1963, xend=1963, y=0, yend=56.5, size=.9) +
    theme(
        axis.title.y=element_blank()
        , axis.text.y=element_blank()
        , axis.text.x = element_text(angle = 90)
        #, axis.ticks.y=element_blank()
        )
g
rayshader::plot_gg(g)
```

